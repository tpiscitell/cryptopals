package main

import (
	"fmt"

	"github.com/tpiscitell/cryptopals/utils"
)

func EncryptionOracle(in []byte) []byte {
	extraCount := utils.RandInt(5) + 5

	var paddedIn []byte

	paddedIn = append(paddedIn, utils.RandBytes(extraCount)...)
	paddedIn = append(paddedIn, in...)
	paddedIn = append(paddedIn, utils.RandBytes(extraCount)...)

	key := utils.RandBytes(16)

	if utils.RandInt(2)%2 == 0 {
		fmt.Println("Using CBC!")
		iv := utils.RandBytes(16)

		return utils.AesCbcEncrypt(in, key, iv)
	} else {
		fmt.Println("Using ECB!")
		return utils.AesEcbEncrypt(in, key)
	}
}

func main() {
	in := []byte{
		0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
		0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
		0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
		0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
		0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
		0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
		0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
		0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
		0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
		0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
		0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
		0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
		0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
		0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
	}

	out := EncryptionOracle(in)

	repeats := utils.CountRepeats(out, 16)

	if repeats > 0 {
		fmt.Println("Detected ECB")
	} else {
		fmt.Println("Detected CBC")
	}

}
